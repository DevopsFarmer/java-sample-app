pipeline{
  agent any 
  environment {
    S3_BUCKET = "cdc-test-2025-bucket"
    AWS_REGION = "us-east-1"
    ARTIFACT = "target/DevOpsFarm-5.1.jar"
  }
  tools {maven 'Maven_CDAC'}
  stages{
    stage('Git Clone'){
      steps{
        git branch: 'main', credentialsId: 'dinesh-github-credentials', url: 'https://github.com/DevopsFarmer/java-sample-app.git'
      }
    }

    stage('Build App'){
      steps{
        sh 'mvn clean install'
      }
    }
    stage('Sonar Scanning'){
      environment {
          scanner = tool 'Sonar'
      }
      steps{
          withSonarQubeEnv('cdac_sonar'){
              sh '''
                  ${scanner}/bin/sonar-scanner -Dsonar.projectKey=CDCJavaApp \
                  -Dsonar.sources=. \
                  -Dsonar.projectName=CDC \
                  -Dsonar.java.binaries=target \
                  -Dsonar.organization=devopsfarm-trainings
              '''
          }
      }
    }
    stage('Approve Deployment') {
      steps {
        input message: 'Do you approve this deployment?', ok: "Deploy"
      }
    } 
    stage('Deploy to S3'){
      steps{
        withAWS(
          credentials: 'AWS_CREDENTIALS',
          region: "${AWS_REGION}"
        ) {
            s3Upload(
            bucket: "${S3_BUCKET}",
            path: "artifacts/",
            file: "${ARTIFACT}"
            )
        }
      }
    }
  }
}
