pipeline{
  agent any 
  environment {
    S3_TEST_BUCKET = "cdc-test-2025-bucket"
    S3_PROD_BUCKET = "cdc-prod-2025-bucket"
    AWS_REGION = "us-east-1"
    ARTIFACT = "target/DevOpsFarm-5.1.jar"
  }
  parameters{
    choice(name: 'ENVIRONMENT', choices: ['Test', 'Prod'], description: 'Select Environment for deployment')
    booleanParam(name: 'RUN_SONAR', defaultValue: true, description: 'Click checkbox to run Sonar stage')
  }
  tools {maven 'Maven_CDAC'}
  stages{
    stage('Git Clone'){
      steps{
        git branch: 'main', credentialsId: 'dinesh-github-credentials', url: 'https://github.com/DevopsFarmer/java-sample-app.git'
      }
    }

    stage('Build App'){
      steps{
        sh 'mvn clean install'
      }
    }
    stage('Sonar Scanning'){
      when {
        expression { params.RUN_SONAR == true }
      }
      environment {
          scanner = tool 'Sonar'
      }
      steps{
          withSonarQubeEnv('cdac_sonar'){
              sh '''
                  ${scanner}/bin/sonar-scanner -Dsonar.projectKey=CDCJavaApp \
                  -Dsonar.sources=. \
                  -Dsonar.projectName=CDC \
                  -Dsonar.java.binaries=target \
                  -Dsonar.organization=devopsfarm-trainings
              '''
          }
      }
    }
    stage('Approve Deployment') {
      steps {
        input message: 'Do you approve this deployment?', ok: "Deploy"
      }
    } 
    stage('Deploy to S3'){
      steps{
        script{
        if (params.ENVIRONMENT == 'Prod') {
          bucketName = 'cdc-prod-2025-bucket'
        }
        else {
          bucketName = 'cdc-test-2025-bucket'
        }
        withAWS(
          credentials: 'AWS_CREDENTIALS',
          region: "${AWS_REGION}"
        ) {
            s3Upload(
            bucket: bucketName,
            path: "artifacts/",
            file: "${ARTIFACT}"
            )
        }
      }
      }
    }
  }
  post{
    always {
      echo "I am running always, whether Job fails or passed"
    }
    success {
      echo "Deployed successfully"
    }
    failure {
      echo "Deployment failed, please check logs for more details"
    }
  }
}
